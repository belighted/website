lang: "en"
slug: "when-a-project-goes-international"
originalPath: "https://www.belighted.com/blog/when-a-project-goes-international"
title: "When a project goes international"
author: "Philippe V."
description: "How we helped a client expand its market from a single country to international. "
image: "https://www.belighted.com/hubfs/Blog/Belighted%20Blog%20Images/going-international.jpg#keepProtocol"
date: 1451606400000
body: "<h2>Introduction</h2>\n<p>Recently, one of our customers&nbsp;asked us to help them expand their market to a new country: France. Peek behind the scenes to see what we did and then check out the results in the <a href=\"https://www.belighted.com/case-studies/listminut-increases-their-product-development-speed-by-90-with-belighted\">case study</a> for Listminut.</p>\n<!--more-->\n<p>The&nbsp;<a href=\"https://listminut.be\">ListMinut</a><span>&nbsp;</span>platform is a marketplace allowing people to find service providers for small jobs like babysitting, plumbing, or gardening. The location is therefore extremely important and they wanted the French users to browse a France-scoped site while keeping the current experience the same for the Belgian users.&nbsp;</p>\n<p>They also wanted to keep a single administration panel and also not fork the codebase in order to easily fix bugs or make global changes in the future.</p>\n<p>Therefore we needed to evolve their current codebase so that a single application could handle differently users visiting <a href=\"www.listminut.be\">www.listminut.be</a> and <a href=\"www.listminut.fr\">www.listminut.fr</a></p>\n<p>We had a meeting with them in order to plan the evolution of the app and prioritize steps based on the criticity of the task and the external constraints.</p>\n<p>After some discussions we agreed with them on the following steps :</p>\n<ul>\n<li>The app must be able to tell the country of a request</li>\n<li>The bank account format must be validated differently depending on the country</li>\n<li>The national identification number must be validated differently depending on the country</li>\n<li>The locations must be searched only for the current country</li>\n<li>The address suggestions (using google place autocomplete) must be scoped for the current country</li>\n<li>The payment gateway must propose different payment methods depending on the country</li>\n<li>The URLs in the emails sent by the application must use the correct hostname</li>\n<li>The job categories proposed must be different from one country to another</li>\n<li>The language switcher must only propose languages of the country or must be hidden if the country only has one language</li>\n<li>The admin panel must propose a combinable filter on the country (which means all the current filters can optionally be combined with a country)</li>\n<li>The newsletter must be different from one country to another</li>\n<li>The highlighted reviews exposed on the home page must have been posted by people of the same country</li>\n<li>The default prices of a job category must depend upon the country</li>\n<li>The cache must take the country into account when relevant</li>\n</ul>\n<p>Some of these changes were structural ones while others were much simpler. Let's review the most interesting changes.</p>\n<h2>The app must be able to tell the country of a request</h2>\n<p>Obviously nothing can be done until we can tell if a request comes from France or Belgium or any other country the system might handle in the future.</p>\n<p>Since the French users will access the website using <a href=\"www.listminut.fr\">www.listminut.fr</a> and the current Belgian users will access it using <a href=\"www.listminut.be\">www.listminut.be</a>, the straightforward solution is to check the hostname and choose a country based on the TLD.</p>\n<p>The problem with this approach is that it will only work in production. Whenever we are in dev, test, staging or any other environment than production we won't have a TLD at our disposal. We could use a trick on a development machine but it would not work for staging or <strong><a href=\"https://www.belighted.com/blog/continuous-delivery-startups\">ci environment</a></strong>.</p>\n<p>Thus we decided to set a chain of places to lookup for a country hint and this chain would end with the TLD. Before that we would check for a custom cookie (easily settable with a browser plugin) or even a query_string param.</p>\n<p>Technically speaking, we thought this solution was very close to the one of setting the locale of the request and added a <code>before_action</code> in our <code>HasLocale</code> controller concern. This also enabled us to choose the default locale depending on the country.</p>\n<p>From this moment we were able to call <code>current_country</code> from any controller and be sure to get a <code>Country</code> record.</p>\n<h2>Some validations depend on the country</h2>\n<p>This looked like a tricky one but ended up easier than we thought. Our first idea was to pass the request country down to the validation process like some kind of context. But something felt wrong and we realized going down that path would mean passing the country along in a lot of calls. Then we thought about storing the country in some kind of thread/request-specific variable (like <code>I18n.locale</code>) but we didn't like that idea either because it is just a disguised constant in terms of dependency management; and actually most of us do not like how any piece of code can access <code>I18n.locale</code>. Then we walked a step back and realised the country should be an associated record of our main object: a <code>User</code> is deeply associated with a country (at least in this project), a <code>Worker</code> also and so is a <code>Job</code> and an <code>Address</code>. Validating correctly a social security number, a bank account IBAN or a VAT number was just a matter of delegating the validation to the indirectly associated country.</p>\n<p>The main problem was resolved but we were left with a more tricky one: countries were instances of a <code>Country</code> class but different instances needed different implementation of the same method. The <code>belgium.verify_national_id_number(user, national_number)</code> should be different than <code>france.verify_national_id_number(user, national_number)</code> even if those two objects were of the same <code>Country</code> class.</p>\n<p>This is a typical data vs. code problem and we solved it using the well-known <a href=\"http://www.oodesign.com/strategy-pattern.html\">strategy pattern</a>.</p>\n<p>Once users were associated with countries, we easily found solutions for the email URLs problem and the separate newsletter.</p>\n<h2>The job categories must be different from one country to another</h2>\n<p>This one was probably the most interesting for us. The initial codebase was several years old and was authored by one senior developer and several trainees over the year. This meant that the categories were displayed on several parts of the webapps and almost every time in a different fashion. Most of the times the categories were even requested from the database directly in the template.</p>\n<p>We solved the problem in 3 steps:</p>\n<p>1. Create a PORO <code>CategoryTree</code> representing a browsable (enumerable) tree of the category.</p>\n<p>2. Use that <code>CategoryTree</code> everywhere it could be used.</p>\n<p>3. Add factory methods to build country-specific or level-specific (categories are either primary or secondary) trees.</p>\n<p>It turned out to be very effective and even allowed us to fix some bugs and dramatically improve the performance on most pages because our tree was buildable in a pair of requests instead of N+1.</p>\n<p>Since part of the app is built on angular 2, we also built a <code>CategoryTree</code> object in javascript, easily transferable from the server.</p>\n<h2>Conclusion</h2>\n<p>The rest of the problems were either straightforward (change some controller actions by using the newly provided <code>current_country</code>) or mostly non-technical (contact the <a href=\"https://www.belighted.com/blog/choosing-payment-processor-marketplace\">payment gateway provider</a> to propose payment mechanisms based on the country).</p>\n<p>In the end we managed to do the expected work in a tight schedule (around one man month) and our client has been able to launch its service in Paris as expected.</p>\n<p>It was also very interesting for us to make such a deep change in an external codebase. The biggest lesson we learnt (again) was not technical but organisational: the communication between the people involved (developers and business actors) was critical to achieve this success.</p>\n<p>Thank you again ListMinut for your trust and we wish you the best in France!</p>\n<p><!--HubSpot Call-to-Action Code --><span class=\"hs-cta-wrapper\" id=\"hs-cta-wrapper-fb3606cc-cc1b-47d0-ae85-2c9f69837fe2\"><span class=\"hs-cta-node hs-cta-fb3606cc-cc1b-47d0-ae85-2c9f69837fe2\" id=\"hs-cta-fb3606cc-cc1b-47d0-ae85-2c9f69837fe2\"><!--[if lte IE 8]><div id=\"hs-cta-ie-element\"></div><![endif]--><a href=\"https://cta-redirect.hubspot.com/cta/redirect/1684659/fb3606cc-cc1b-47d0-ae85-2c9f69837fe2\" target=\"_blank\"><img class=\"hs-cta-img\" id=\"hs-cta-img-fb3606cc-cc1b-47d0-ae85-2c9f69837fe2\" style=\"border-width:0px;\" src=\"https://no-cache.hubspot.com/cta/default/1684659/fb3606cc-cc1b-47d0-ae85-2c9f69837fe2.png\" alt=\"New Call-to-action\"></a></span></span><!-- end HubSpot Call-to-Action Code --></p>"
tags:
  - label: "Under the hood"
    value: "under-the-hood"

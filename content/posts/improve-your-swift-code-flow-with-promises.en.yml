lang: en
slug: improve-your-swift-code-flow-with-promises
originalPath: https://www.belighted.com/blog/improve-your-swift-code-flow-with-promises
title: Improve your Swift code flow with promises
author: MichaÃ«l A.
description: In this article, I'll talk about the callback syntax. When an
  asynchronous method finishes, it calls back its caller for the next step of
  the process. In terms of sustainability, this approach presents some
  weaknesses as the global logic is spread among the code. PromiseKit proposes
  an interesting alternative inspired from JavaScript.
image: ./images/promisekit-blogpost-img.png
date: 1420070400000
body: >-
  <p>The feeling of smoothness given by an application is something that matters
  for users. Apple has perfectly understood this point and brings useful tools
  to ease the life of developers: multi-threading, Grand Central Dispatch,
  callbacks, delegates... These techniques are helpful to set up asynchronous
  processes and keep the main thread available for the interfaces and user
  interactions.</p>

  <!--more-->

  <h2>The callback syntax</h2>

  <p>When an asynchronous method finishes, it calls back its caller for the next step of the process. In terms of sustainability, this approach presents some weaknesses as the global logic is spread among the code. PromiseKit proposes an interesting alternative inspired from JavaScript. For a few years now, JavaScript has been enriched with the concept of <em>promise</em> to represent the result of an asynchronous operation. Promise substitutes callback.</p>

  <p>PromiseKit is a framework, supporting both Objective-C and Swift, that brings Promise concept to your iOS code. But there is more to it than just changing the syntax in your code. The use of promise gives the opportunity to reduce code complexity.</p>

  <blockquote>

  <p>PromiseKit is not just a promises implementation, it is also a collection of helper functions that make the typical asynchronous patterns we use as iOS developers delightful too.</p>

  </blockquote>

  <p>I'll give an example to show how the use of promises helped me in an iOS project. Imagine an application that contains establishments providing services to population to be displayed on a map. Establishments and services should be downloaded on a regular basis and stored with CoreData.</p>

  <h2>The implementation</h2>

  <p>First, let's write a service that will be in charge of synchronizing the data. We'll first synchronized the services, that is referential data to create the relationship in the database.</p>

  <pre><code class="undefined">class SyncService: NSObject {
    func syncDataFromServer() {
      self.syncServices().then {_ in
         return self.syncEstablishments()
      }.then { _ in
         // send a notification via GCD
         NSNotificationCenter.defaultCenter().postNotificationName(ServerSynchronisationDone, object: nil, userInfo: nil)
      }
    }
  </code></pre>

  <p><br> All the business logic is encompassed in this single method. The app will fetch and save the services. When this operation will successfully finish, then it will synchronize the establishments. When the whole processing is done, I often use the GCD to send a completion notification. I find this solution really elegant and easy to notify the current view controller (whatever it is).</p>

  <p>Let's write some code to detail for example how the method syncServices can look like. Having a look at the method syncServices you can understand what is going on :</p>

  <blockquote>

  <ul>

  <li>Get the last update date,</li>

  <li>Get the data from the server,</li>

  <li>Map the results to a managed object (if successful)</li>

  <li>Save the results into CoreData</li>

  </ul>

  </blockquote>

  <p>Both fetching results on HTTP or saving records in CoreData are asynchronous processes. They are good candidates to write as promise.</p>

  <pre><code class="ruby">extension <span class="constant">SyncService</span>{
      func syncServices() -&gt; <span class="constant">Promise</span>&lt;[<span class="constant">Service</span>]&gt; {
          let lastServiceUpdateDate = <span class="constant">PersistenceManager</span>.sharedInstance.getLastUpdatedService()
          <span class="keyword">return</span> fetchPromise = <span class="keyword">self</span>.fetchServicesFromDate(lastService!.updatedAt).<span class="keyword">then</span> {
              jsonResult <span class="keyword">in</span> <span class="keyword">self</span>.parseServicesJson(jsonResult)
          }.<span class="keyword">then</span> {
              serviceMaps <span class="keyword">in</span> <span class="keyword">self</span>.storeServiceInCoreData(serviceMaps)
          }
      }
      func fetchServicesFromDate(fromDate<span class="symbol">:</span> <span class="constant">NSDate</span>?) -&gt; <span class="constant">Promise</span>&lt;<span class="constant">AnyObject</span>&gt;{
          <span class="keyword">return</span> <span class="constant">Promise</span> { fulfill, reject <span class="keyword">in</span>
              <span class="constant">Alamofire</span>.request(...).responseJSON{ response <span class="keyword">in</span>
                  let serverResponse = response.response
                      <span class="keyword">if</span>(serverResponse?.statusCode &lt; <span class="number">200</span> || serverResponse?.statusCode &gt; <span class="number">299</span>) {
                      let error = <span class="constant">NSError</span>(domain<span class="symbol">:</span> <span class="string">"http"</span>, code<span class="symbol">:</span> <span class="number">123</span>, userInfo<span class="symbol">:</span> [<span class="string">"errorDescription"</span><span class="symbol">:<span class="string">"Server answers with a wrong status."</span></span>])
                      reject(error)
                  }

                  <span class="keyword">if</span> let <span class="constant">JSON</span> = response.result.value {
                      fulfill(<span class="constant">JSON</span>)
                  }
              }
          }
      }
      func parseServicesJson(json<span class="symbol">:</span> <span class="constant">AnyObject</span>) -&gt; <span class="constant">Promise</span>&lt;[<span class="constant">ServiceMap</span>]&gt; {
        ...
      }
       func storeServiceInCoreData(results<span class="symbol">:</span> [<span class="constant">ServiceMap</span>]) -&gt; <span class="constant">Promise</span>&lt;[<span class="constant">Service</span>]&gt; {

          <span class="keyword">return</span> <span class="constant">Promise</span> { fulfill, reject <span class="keyword">in</span>
              var services = [<span class="constant">Service</span>]()
              <span class="constant">CDK</span>.performBlockOnBackgroundContext({ context <span class="keyword">in</span>
              <span class="keyword">do</span> {
                      ...
                      <span class="keyword">return</span> .<span class="constant">SaveToPersistentStore</span>
                  }
                  catch {
                      let error = <span class="constant">NSError</span>()
                      reject(error)
                  }
                  }, completionHandler<span class="symbol">:</span> { result <span class="keyword">in</span>
                      fulfill(services)
                  }
              )
          }
      }
  }

  </code></pre>

  <p>&nbsp;</p>

  <h2>To learn more</h2>

  <ul>

  <li><strong><a href="https://promisekit.org/">PromiseKit's documentation</a></strong></li>

  <li><strong><a href="https://github.com/mxcl/PromiseKit">PromiseKit's github</a></strong></li>

  </ul>

  <p><!--HubSpot Call-to-Action Code --><span class="hs-cta-wrapper" id="hs-cta-wrapper-fb3606cc-cc1b-47d0-ae85-2c9f69837fe2"><span class="hs-cta-node hs-cta-fb3606cc-cc1b-47d0-ae85-2c9f69837fe2" id="hs-cta-fb3606cc-cc1b-47d0-ae85-2c9f69837fe2"><!--[if lte IE 8]><div id="hs-cta-ie-element"></div><![endif]--><a href="https://cta-redirect.hubspot.com/cta/redirect/1684659/fb3606cc-cc1b-47d0-ae85-2c9f69837fe2" target="_blank"><img class="hs-cta-img" id="hs-cta-img-fb3606cc-cc1b-47d0-ae85-2c9f69837fe2" style="border-width:0px;" src="https://no-cache.hubspot.com/cta/default/1684659/fb3606cc-cc1b-47d0-ae85-2c9f69837fe2.png" alt="New Call-to-action"></a></span></span><!-- end HubSpot Call-to-Action Code --></p>

  <div id="disqus_thread">&nbsp;</div>
tags:
  - label: Under the hood
    value: under-the-hood

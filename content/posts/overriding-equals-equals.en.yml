lang: "en"
slug: "overriding-equals-equals"
originalPath: "https://www.belighted.com/blog/overriding-equals-equals"
title: "Overriding ==, eql? and hash"
author: "Dominique L."
description: "It is quite usual in object-oriented programming to redefine the criteria of equivalence between two instances of a class."
image: "https://belighted.com/images/default_blogpost_image_2@1x.jpg#keepProtocol"
date: 1356998400000
body: "<p>It is quite usual in object-oriented programming to redefine the criteria of equivalence between two instances of a class. For example, let’s write a class representing a specific point in a three-dimensional space:</p>\n<!--more-->\n<figure class=\"code\">\n<div class=\"highlight\">\n<table>\n<tbody>\n<tr>\n<td class=\"gutter\">\n<pre class=\"line-numbers\"><span class=\"line-number\">1</span>\n<span class=\"line-number\">2</span>\n<span class=\"line-number\">3</span>\n<span class=\"line-number\">4</span>\n<span class=\"line-number\">5</span>\n<span class=\"line-number\">6</span>\n</pre>\n</td>\n<td class=\"code\">\n<pre><code class=\"ruby\"><span class=\"line\"><span class=\"k\"><span class=\"class\"><span class=\"keyword\">class</span></span></span><span class=\"class\"> <span class=\"nc\"><span class=\"title\">Point</span></span></span><span class=\"nc\"></span>\n</span><span class=\"line\"> <span class=\"kp\">attr_reader</span> <span class=\"ss\"><span class=\"symbol\">:x</span></span><span class=\"p\">,</span> <span class=\"ss\"><span class=\"symbol\">:y</span></span><span class=\"p\">,</span> <span class=\"ss\"><span class=\"symbol\">:z</span></span>\n</span><span class=\"line\"> <span class=\"k\"><span class=\"function\"><span class=\"keyword\">def</span></span></span><span class=\"function\"> <span class=\"nf\"><span class=\"title\">initialize</span></span><span class=\"p\"><span class=\"params\">(</span></span><span class=\"params\"><span class=\"n\">x</span><span class=\"p\">,</span> <span class=\"n\">y</span><span class=\"p\">,</span> <span class=\"n\">z</span><span class=\"p\">)</span></span><span class=\"p\"></span></span><span class=\"p\"></span>\n</span><span class=\"line\"> <span class=\"vi\"><span class=\"variable\">@x</span></span><span class=\"p\">,</span> <span class=\"vi\"><span class=\"variable\">@y</span></span><span class=\"p\">,</span> <span class=\"vi\"><span class=\"variable\">@z</span></span> <span class=\"o\">=</span> <span class=\"n\">x</span><span class=\"p\">,</span> <span class=\"n\">y</span><span class=\"p\">,</span> <span class=\"n\">z</span>\n</span><span class=\"line\"> <span class=\"k\"><span class=\"keyword\">end</span></span>\n</span><span class=\"line\"><span class=\"k\"><span class=\"keyword\">end</span></span>\n</span></code></pre>\n</td>\n</tr>\n</tbody>\n</table>\n</div>\n</figure>\n<p>Given two points p1 and p2 with the same x, y and z coordinates, it seems natural that p1 be considered equivalent to p2, whether p1 and p2 are the same instance (i.e. the same memory object) or not. In Ruby, the method used to check the equivalence of two objects is <code>==</code>. Its default implementation (on the Object class) checks for instance identity, so we have to override it in our class to satisfy our domain specific notion of equivalence:</p>\n<figure class=\"code\">\n<div class=\"highlight\">\n<table>\n<tbody>\n<tr>\n<td class=\"gutter\">\n<pre class=\"line-numbers\"><span class=\"line-number\">1</span>\n<span class=\"line-number\">2</span>\n<span class=\"line-number\">3</span>\n</pre>\n</td>\n<td class=\"code\">\n<pre><code class=\"ruby\"><span class=\"line\"><span class=\"k\"><span class=\"function\"><span class=\"keyword\">def</span></span></span><span class=\"function\"> <span class=\"nf\"><span class=\"title\">==</span></span><span class=\"p\"><span class=\"params\">(</span></span><span class=\"params\"><span class=\"n\">other</span><span class=\"p\">)</span></span><span class=\"p\"></span></span><span class=\"p\"></span>\n</span><span class=\"line\"> <span class=\"n\">x</span> <span class=\"o\">==</span> <span class=\"n\">other</span><span class=\"o\">.</span><span class=\"n\">x</span> <span class=\"o\">&amp;&amp;</span> <span class=\"n\">y</span> <span class=\"o\">==</span> <span class=\"n\">other</span><span class=\"o\">.</span><span class=\"n\">y</span> <span class=\"o\">&amp;&amp;</span> <span class=\"n\">z</span> <span class=\"o\">==</span> <span class=\"n\">other</span><span class=\"o\">.</span><span class=\"n\">z</span>\n</span><span class=\"line\"><span class=\"k\"><span class=\"keyword\">end</span></span>\n</span></code></pre>\n</td>\n</tr>\n</tbody>\n</table>\n</div>\n</figure>\n<p>Let’s try it:</p>\n<figure class=\"code\">\n<div class=\"highlight\">\n<table>\n<tbody>\n<tr>\n<td class=\"gutter\">\n<pre class=\"line-numbers\"><span class=\"line-number\">1</span>\n<span class=\"line-number\">2</span>\n</pre>\n</td>\n<td class=\"code\">\n<pre><code class=\"ruby\"><span class=\"line\"><span class=\"n\">irb</span><span class=\"p\">(</span><span class=\"n\">main</span><span class=\"p\">)<span class=\"symbol\">:</span></span><span class=\"mo\"><span class=\"number\">001</span></span><span class=\"p\"><span class=\"symbol\">:</span></span><span class=\"mi\"><span class=\"number\">0</span></span><span class=\"o\">&gt;</span> <span class=\"no\"><span class=\"constant\">Point</span></span><span class=\"o\">.</span><span class=\"n\">new</span><span class=\"p\">(</span><span class=\"mi\"><span class=\"number\">0</span></span><span class=\"p\">,</span> <span class=\"mi\"><span class=\"number\">0</span></span><span class=\"p\">,</span> <span class=\"mi\"><span class=\"number\">0</span></span><span class=\"p\">)</span> <span class=\"o\">==</span> <span class=\"no\"><span class=\"constant\">Point</span></span><span class=\"o\">.</span><span class=\"n\">new</span><span class=\"p\">(</span><span class=\"mi\"><span class=\"number\">0</span></span><span class=\"p\">,</span> <span class=\"mi\"><span class=\"number\">0</span></span><span class=\"p\">,</span> <span class=\"mi\"><span class=\"number\">0</span></span><span class=\"p\">)</span>\n</span><span class=\"line\"><span class=\"o\">=&gt;</span> <span class=\"kp\"><span class=\"keyword\">true</span></span>\n</span></code></pre>\n</td>\n</tr>\n</tbody>\n</table>\n</div>\n</figure>\n<p>So far, so good.</p>\n<h3>Using our objects as hash keys</h3>\n<p>Now what if we want to use our newly defined objects as a key in a Hash?</p>\n<figure class=\"code\">\n<div class=\"highlight\">\n<table>\n<tbody>\n<tr>\n<td class=\"gutter\">\n<pre class=\"line-numbers\"><span class=\"line-number\">1</span>\n<span class=\"line-number\">2</span>\n<span class=\"line-number\">3</span>\n</pre>\n</td>\n<td class=\"code\">\n<pre><code class=\"ruby\"><span class=\"line\"><span class=\"n\">irb</span><span class=\"p\">(</span><span class=\"n\">main</span><span class=\"p\">)<span class=\"symbol\">:</span></span><span class=\"mo\"><span class=\"number\">001</span></span><span class=\"p\"><span class=\"symbol\">:</span></span><span class=\"mi\"><span class=\"number\">0</span></span><span class=\"o\">&gt;</span> <span class=\"n\">labels</span> <span class=\"o\">=</span> <span class=\"p\">{</span> <span class=\"no\"><span class=\"constant\">Point</span></span><span class=\"o\">.</span><span class=\"n\">new</span><span class=\"p\">(</span><span class=\"mi\"><span class=\"number\">0</span></span><span class=\"p\">,</span> <span class=\"mi\"><span class=\"number\">0</span></span><span class=\"p\">,</span> <span class=\"mi\"><span class=\"number\">0</span></span><span class=\"p\">)</span> <span class=\"o\">=&gt;</span> <span class=\"err\">“</span><span class=\"no\"><span class=\"constant\">Origin</span></span><span class=\"err\">”</span> <span class=\"p\">}</span>\n</span><span class=\"line\"><span class=\"n\">irb</span><span class=\"p\">(</span><span class=\"n\">main</span><span class=\"p\">)<span class=\"symbol\">:</span></span><span class=\"mo\"><span class=\"number\">002</span></span><span class=\"p\"><span class=\"symbol\">:</span></span><span class=\"mi\"><span class=\"number\">0</span></span><span class=\"o\">&gt;</span> <span class=\"n\">labels</span><span class=\"o\">[</span><span class=\"no\"><span class=\"constant\">Point</span></span><span class=\"o\">.</span><span class=\"n\">new</span><span class=\"p\">(</span><span class=\"mi\"><span class=\"number\">0</span></span><span class=\"p\">,</span> <span class=\"mi\"><span class=\"number\">0</span></span><span class=\"p\">,</span> <span class=\"mi\"><span class=\"number\">0</span></span><span class=\"p\">)</span><span class=\"o\">]</span>\n</span><span class=\"line\"><span class=\"o\">=&gt;</span> <span class=\"kp\"><span class=\"keyword\">nil</span></span>\n</span></code></pre>\n</td>\n</tr>\n</tbody>\n</table>\n</div>\n</figure>\n<p>Not exactly what we want. This is because Hash does not use the <code>==</code> method when it looks for a key. Rather, it uses the eql? method as well as the hash method, which are also defined on Object. So, let’s first redefine <code>eql?</code>. As is often the case, it is perfectly sensible in our example to make <code>eql?</code> and <code>==</code> synonymous:</p>\n<figure class=\"code\">\n<div class=\"highlight\">\n<table>\n<tbody>\n<tr>\n<td class=\"gutter\">\n<pre class=\"line-numbers\"><span class=\"line-number\">1</span>\n<span class=\"line-number\">2</span>\n<span class=\"line-number\">3</span>\n</pre>\n</td>\n<td class=\"code\">\n<pre><code class=\"ruby\"><span class=\"line\"><span class=\"k\"><span class=\"function\"><span class=\"keyword\">def</span></span></span><span class=\"function\"> <span class=\"nf\"><span class=\"title\">eql?</span></span><span class=\"p\"><span class=\"params\">(</span></span><span class=\"params\"><span class=\"n\">other</span><span class=\"p\">)</span></span><span class=\"p\"></span></span><span class=\"p\"></span>\n</span><span class=\"line\"> <span class=\"nb\"><span class=\"keyword\">self</span></span> <span class=\"o\">==</span> <span class=\"n\">other</span>\n</span><span class=\"line\"><span class=\"k\"><span class=\"keyword\">end</span></span>\n</span></code></pre>\n</td>\n</tr>\n</tbody>\n</table>\n</div>\n</figure>\n<p>Now hash. This method returns an integer representing a kind of address where the key should be stored or found in a hashtable, called the hash value of the object. According to its specification, if <code>object1.eql?(object2)</code> is true then <code>object1.hash</code> MUST be equal to <code>object2.hash</code> (i.e. if a key matches another, they must be found at the same address). The reverse does not have to be true: <code>object1.hash</code> can be equal to <code>object2.hash</code> even when <code>object1.eql?(object2)</code> is false, this situation being called a collision. However, lookup performances tend to drop as the number of collisions rises, so a good implementation should try to minimize their probability (a property of the hash function called uniformity, see reference 4). There are many possible ways to compute a hash value for our Point instances (this topic deserves its own blogpost), but here is a simple one (assuming that the implementation provided by Array is a good one):</p>\n<figure class=\"code\">\n<div class=\"highlight\">\n<table>\n<tbody>\n<tr>\n<td class=\"gutter\">\n<pre class=\"line-numbers\"><span class=\"line-number\">1</span>\n<span class=\"line-number\">2</span>\n<span class=\"line-number\">3</span>\n</pre>\n</td>\n<td class=\"code\">\n<pre><code class=\"ruby\"><span class=\"line\"><span class=\"k\"><span class=\"function\"><span class=\"keyword\">def</span></span></span><span class=\"function\"> <span class=\"nf\"><span class=\"title\">hash</span></span></span><span class=\"nf\"></span>\n</span><span class=\"line\"> <span class=\"o\">[</span> <span class=\"n\">x</span><span class=\"p\">,</span> <span class=\"n\">y</span><span class=\"p\">,</span> <span class=\"n\">z</span> <span class=\"o\">].</span><span class=\"n\">hash</span>\n</span><span class=\"line\"><span class=\"k\"><span class=\"keyword\">end</span></span>\n</span></code></pre>\n</td>\n</tr>\n</tbody>\n</table>\n</div>\n</figure>\n<p>Now if we try again, we get:</p>\n<figure class=\"code\">\n<div class=\"highlight\">\n<table>\n<tbody>\n<tr>\n<td class=\"gutter\">\n<pre class=\"line-numbers\"><span class=\"line-number\">1</span>\n<span class=\"line-number\">2</span>\n<span class=\"line-number\">3</span>\n</pre>\n</td>\n<td class=\"code\">\n<pre><code class=\"ruby\"><span class=\"line\"><span class=\"n\">irb</span><span class=\"p\">(</span><span class=\"n\">main</span><span class=\"p\">)<span class=\"symbol\">:</span></span><span class=\"mo\"><span class=\"number\">001</span></span><span class=\"p\"><span class=\"symbol\">:</span></span><span class=\"mi\"><span class=\"number\">0</span></span><span class=\"o\">&gt;</span> <span class=\"n\">labels</span> <span class=\"o\">=</span> <span class=\"p\">{</span> <span class=\"no\"><span class=\"constant\">Point</span></span><span class=\"o\">.</span><span class=\"n\">new</span><span class=\"p\">(</span><span class=\"mi\"><span class=\"number\">0</span></span><span class=\"p\">,</span> <span class=\"mi\"><span class=\"number\">0</span></span><span class=\"p\">,</span> <span class=\"mi\"><span class=\"number\">0</span></span><span class=\"p\">)</span> <span class=\"o\">=&gt;</span> <span class=\"err\">“</span><span class=\"no\"><span class=\"constant\">Origin</span></span><span class=\"err\">”</span> <span class=\"p\">}</span>\n</span><span class=\"line\"><span class=\"n\">irb</span><span class=\"p\">(</span><span class=\"n\">main</span><span class=\"p\">)<span class=\"symbol\">:</span></span><span class=\"mo\"><span class=\"number\">004</span></span><span class=\"p\"><span class=\"symbol\">:</span></span><span class=\"mi\"><span class=\"number\">0</span></span><span class=\"o\">&gt;</span> <span class=\"n\">labels</span><span class=\"o\">[</span><span class=\"no\"><span class=\"constant\">Point</span></span><span class=\"o\">.</span><span class=\"n\">new</span><span class=\"p\">(</span><span class=\"mi\"><span class=\"number\">0</span></span><span class=\"p\">,</span> <span class=\"mi\"><span class=\"number\">0</span></span><span class=\"p\">,</span> <span class=\"mi\"><span class=\"number\">0</span></span><span class=\"p\">)</span><span class=\"o\">]</span>\n</span><span class=\"line\"><span class=\"o\">=&gt;</span> <span class=\"err\">“</span><span class=\"no\"><span class=\"constant\">Origin</span></span><span class=\"err\">”</span>\n</span></code></pre>\n</td>\n</tr>\n</tbody>\n</table>\n</div>\n</figure>\n<p>Bingo!</p>\n<h3>Other equality/equivalence related methods</h3>\n<p>Object also defines two other methods that are related to equality/equivalence: <code>equal?</code> determines object identity (i.e if a is the same instance as b) and should never be overridden. On the other hand, case statements use the <code>===</code> method to select the appropriate when, so here again you can override it to provide class specific equivalence for a switch statement (Range is a good example of this, see the documentation).</p>\n<h3>References and further reading:</h3>\n<ol>\n<li><strong><a href=\"https://ruby-doc.org/core-1.9.3/Object.html#method-i-eql-3F\">Specification of ==, eql? and equal?</a></strong></li>\n<li><strong><a href=\"https://ruby-doc.org/core-1.9.3/Object.html#method-i-hash\">Specification of hash</a></strong></li>\n<li><strong><a href=\"https://blog.rubybestpractices.com/posts/rklemme/018-Complete_Class.html\">A more complete blogpost on basic concepts that can be implemented/overridden in a class</a></strong></li>\n<li><strong><a href=\"https://en.wikipedia.org/wiki/Hash_value\">Definition and properties of hash values</a></strong></li>\n<li><strong><a href=\"https://edwinmeyer.com/Release_Integrated_RHG_09_10_2008/chapter03.html\">In depth view of Hash implementation in MRI</a></strong></li>\n<li><strong><a href=\"https://www.laurentluce.com/posts/python-dictionary-implementation/\">A blogpost on the implementation of a hashtable (here called a dictionary)</a> </strong>It’s in Python, but the principles are the same.</li>\n</ol>\n<p><!--HubSpot Call-to-Action Code --><span class=\"hs-cta-wrapper\" id=\"hs-cta-wrapper-fb3606cc-cc1b-47d0-ae85-2c9f69837fe2\"><span class=\"hs-cta-node hs-cta-fb3606cc-cc1b-47d0-ae85-2c9f69837fe2\" id=\"hs-cta-fb3606cc-cc1b-47d0-ae85-2c9f69837fe2\"><!--[if lte IE 8]><div id=\"hs-cta-ie-element\"></div><![endif]--><a href=\"https://cta-redirect.hubspot.com/cta/redirect/1684659/fb3606cc-cc1b-47d0-ae85-2c9f69837fe2\" target=\"_blank\"><img class=\"hs-cta-img\" id=\"hs-cta-img-fb3606cc-cc1b-47d0-ae85-2c9f69837fe2\" style=\"border-width:0px;\" src=\"https://no-cache.hubspot.com/cta/default/1684659/fb3606cc-cc1b-47d0-ae85-2c9f69837fe2.png\" alt=\"New Call-to-action\"></a></span></span><!-- end HubSpot Call-to-Action Code --></p>\n<div id=\"disqus_thread\">&nbsp;</div>"
tags:
  - label: "Under the hood"
    value: "under-the-hood"

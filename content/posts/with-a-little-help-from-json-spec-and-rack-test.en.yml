lang: "en"
slug: "with-a-little-help-from-json-spec-and-rack-test"
originalPath: "https://www.belighted.com/blog/with-a-little-help-from-json-spec-and-rack-test"
title: "With a little help from Json_spec and Rack::Test"
author: "Yannick S."
description: "How to use Sinatra, to design a json API in a few days. Discover a small example."
image: "http://belighted.com/images/default_blogpost_image_8@1x.jpg#keepProtocol"
date: 1325376000000
body: "<p>Last week, I had to design a little json API. It had to be fast and furious. For that purpose, we made it with Sinatra.</p>\n<!--more-->\n<p>The point was we didn’t want to make a single file Sinatra app. We made a <strong><a href=\"http://github.com/ys/sinatra-skeleton\">small reusable skeleton</a> </strong>of a Sinatra app using ActiveRecord to store the small amount of objects.</p>\n<p>It had to be full stack tested. For that we used Rspec and <strong><a href=\"https://github.com/brynary/rack-test/\">Rack Test</a> </strong>for the API testing part.</p>\n<p>You can easily check the response payload with something like<strong> <a href=\"https://github.com/collectiveidea/json_spec/\">json_spec</a></strong>. It’s so easy to use.</p>\n<p>Here is a small example:</p>\n<figure class=\"code\">\n<div class=\"highlight\">\n<table>\n<tbody>\n<tr>\n<td class=\"gutter\">\n<pre class=\"line-numbers\"><span class=\"line-number\">1</span>\n<span class=\"line-number\">2</span>\n<span class=\"line-number\">3</span>\n<span class=\"line-number\">4</span>\n<span class=\"line-number\">5</span>\n<span class=\"line-number\">6</span>\n<span class=\"line-number\">7</span>\n</pre>\n</td>\n<td class=\"code\">\n<pre><code class=\"ruby\"><span class=\"line\"> <span class=\"o\">.</span><span class=\"n\">.</span><span class=\"o\">.</span>\n</span><span class=\"line\"> <span class=\"n\">it</span> <span class=\"s1\"><span class=\"string\">'get the greeting'</span></span> <span class=\"k\"><span class=\"keyword\">do</span></span>\n</span><span class=\"line\"> <span class=\"n\">get</span> <span class=\"s2\"><span class=\"string\">\"/api/</span></span><span class=\"string\"><span class=\"si\"><span class=\"subst\">#{</span></span><span class=\"subst\"><span class=\"n\">person</span><span class=\"o\">.</span><span class=\"n\">name</span><span class=\"si\">}</span></span><span class=\"si\"></span><span class=\"s2\">\"</span></span><span class=\"s2\"></span>\n</span><span class=\"line\"> <span class=\"n\">last_response</span><span class=\"o\">.</span><span class=\"n\">should</span> <span class=\"n\">be_ok</span>\n</span><span class=\"line\"> <span class=\"n\">last_json</span><span class=\"o\">.</span><span class=\"n\">should</span> <span class=\"n\">have_json_path</span> <span class=\"s1\"><span class=\"string\">'name'</span></span>\n</span><span class=\"line\"> <span class=\"k\"><span class=\"keyword\">end</span></span>\n</span><span class=\"line\"> <span class=\"o\">.</span><span class=\"n\">.</span><span class=\"o\">.</span>\n</span></code></pre>\n</td>\n</tr>\n</tbody>\n</table>\n</div>\n</figure>\n<p>The <code>last_json</code> object is simply a method defined into the spec_helper.rb file which looks like this:</p>\n<figure class=\"code\">\n<div class=\"highlight\">\n<table>\n<tbody>\n<tr>\n<td class=\"gutter\">\n<pre class=\"line-numbers\"><span class=\"line-number\">1</span>\n<span class=\"line-number\">2</span>\n<span class=\"line-number\">3</span>\n<span class=\"line-number\">4</span>\n<span class=\"line-number\">5</span>\n<span class=\"line-number\">6</span>\n<span class=\"line-number\">7</span>\n<span class=\"line-number\">8</span>\n<span class=\"line-number\">9</span>\n<span class=\"line-number\">10</span>\n<span class=\"line-number\">11</span>\n<span class=\"line-number\">12</span>\n<span class=\"line-number\">13</span>\n<span class=\"line-number\">14</span>\n<span class=\"line-number\">15</span>\n<span class=\"line-number\">16</span>\n<span class=\"line-number\">17</span>\n<span class=\"line-number\">18</span>\n<span class=\"line-number\">19</span>\n<span class=\"line-number\">20</span>\n<span class=\"line-number\">21</span>\n<span class=\"line-number\">22</span>\n<span class=\"line-number\">23</span>\n</pre>\n</td>\n<td class=\"code\">\n<pre><code class=\"ruby\"><span class=\"line\"><span class=\"no\"><span class=\"constant\">ENV</span></span><span class=\"o\">[</span><span class=\"s1\"><span class=\"string\">'RACK_ENV'</span></span><span class=\"o\">]</span> <span class=\"o\">=</span> <span class=\"s1\"><span class=\"string\">'test'</span></span>\n</span><span class=\"line\"><span class=\"c1\"><span class=\"comment\"># Load the Sinatra app</span></span>\n</span><span class=\"line\"><span class=\"nb\"><span class=\"keyword\">require</span></span> <span class=\"no\"><span class=\"constant\">File</span></span><span class=\"o\">.</span><span class=\"n\">join</span><span class=\"p\">(</span> <span class=\"no\"><span class=\"constant\">File</span></span><span class=\"o\">.</span><span class=\"n\">dirname</span><span class=\"p\">(</span><span class=\"bp\"> __FILE_<span class=\"number\">_</span> </span><span class=\"p\">),</span> <span class=\"s1\"><span class=\"string\">'..'</span></span><span class=\"p\">,</span> <span class=\"s1\"><span class=\"string\">'server'</span></span> <span class=\"p\">)</span>\n</span><span class=\"line\">\n</span><span class=\"line\"><span class=\"nb\"><span class=\"keyword\">require</span></span> <span class=\"s1\"><span class=\"string\">'rspec'</span></span>\n</span><span class=\"line\"><span class=\"nb\"><span class=\"keyword\">require</span></span> <span class=\"s1\"><span class=\"string\">'rack/test'</span></span>\n</span><span class=\"line\"><span class=\"nb\"><span class=\"keyword\">require</span></span> <span class=\"s1\"><span class=\"string\">'json_spec'</span></span>\n</span><span class=\"line\">\n</span><span class=\"line\"><span class=\"n\">set</span> <span class=\"ss\"><span class=\"symbol\">:environment</span></span><span class=\"p\">,</span> <span class=\"ss\"><span class=\"symbol\">:test</span></span>\n</span><span class=\"line\">\n</span><span class=\"line\"><span class=\"no\"><span class=\"constant\">RSpec</span></span><span class=\"o\">.</span><span class=\"n\">configure</span> <span class=\"k\"><span class=\"keyword\">do</span></span> <span class=\"o\">|</span><span class=\"n\">conf</span><span class=\"o\">|</span>\n</span><span class=\"line\"> <span class=\"n\">conf</span><span class=\"o\">.</span><span class=\"n\"><span class=\"keyword\">include</span></span> <span class=\"no\"><span class=\"constant\">Rack</span></span><span class=\"constant\"><span class=\"o\">::</span><span class=\"no\">Test</span><span class=\"o\">::</span><span class=\"no\">Methods</span></span><span class=\"no\"></span>\n</span><span class=\"line\"> <span class=\"n\">conf</span><span class=\"o\">.</span><span class=\"n\"><span class=\"keyword\">include</span></span> <span class=\"no\"><span class=\"constant\">JsonSpec</span></span><span class=\"constant\"><span class=\"o\">::</span><span class=\"no\">Helpers</span></span><span class=\"no\"></span>\n</span><span class=\"line\"> <span class=\"c1\"><span class=\"comment\">#all your others informations</span></span>\n</span><span class=\"line\"><span class=\"k\"><span class=\"keyword\">end</span></span>\n</span><span class=\"line\">\n</span><span class=\"line\"><span class=\"k\"><span class=\"function\"><span class=\"keyword\">def</span></span></span><span class=\"function\"> <span class=\"nf\"><span class=\"title\">last_json</span></span></span><span class=\"nf\"></span>\n</span><span class=\"line\"> <span class=\"n\">last_response</span><span class=\"o\">.</span><span class=\"n\">body</span>\n</span><span class=\"line\"><span class=\"k\"><span class=\"keyword\">end</span></span>\n</span><span class=\"line\">\n</span><span class=\"line\"><span class=\"k\"><span class=\"function\"><span class=\"keyword\">def</span></span></span><span class=\"function\"> <span class=\"nf\"><span class=\"title\">app</span></span></span><span class=\"nf\"></span>\n</span><span class=\"line\"> <span class=\"no\"><span class=\"constant\">App</span></span>\n</span><span class=\"line\"><span class=\"k\"><span class=\"keyword\">end</span></span>\n</span></code></pre>\n</td>\n</tr>\n</tbody>\n</table>\n</div>\n</figure>\n<p>With json_spec, you have access to some great matchers like <code>be_json_eq</code>, <code>have_json_path</code> or<code>have_json_size</code> which help a lot doing things like <code>have_json_size(0).at_path(\"friends\")</code>. The doc is really helpful for that.</p>\n<p>With Rack::Test, you have a lot of helpers like the classic http methods. And access to an object <code>last_response</code> which contains the http response of the last request.</p>\n<p>All that helped to get a working API in a couple of days. For more information about the sinatra skeleton, I recommend you another <strong><a href=\"http://blog.yannick.io/blog/2012/07/28/sinatra-skeleton/\">blog post</a> </strong>I wrote on my own blog or don’t hesitate to ask as many questions as you want!<br><br><!--HubSpot Call-to-Action Code --><span class=\"hs-cta-wrapper\" id=\"hs-cta-wrapper-fb3606cc-cc1b-47d0-ae85-2c9f69837fe2\"><span class=\"hs-cta-node hs-cta-fb3606cc-cc1b-47d0-ae85-2c9f69837fe2\" id=\"hs-cta-fb3606cc-cc1b-47d0-ae85-2c9f69837fe2\"><!--[if lte IE 8]><div id=\"hs-cta-ie-element\"></div><![endif]--><a href=\"https://cta-redirect.hubspot.com/cta/redirect/1684659/fb3606cc-cc1b-47d0-ae85-2c9f69837fe2\" target=\"_blank\"><img class=\"hs-cta-img\" id=\"hs-cta-img-fb3606cc-cc1b-47d0-ae85-2c9f69837fe2\" style=\"border-width:0px;\" src=\"https://no-cache.hubspot.com/cta/default/1684659/fb3606cc-cc1b-47d0-ae85-2c9f69837fe2.png\" alt=\"New Call-to-action\"></a></span></span><!-- end HubSpot Call-to-Action Code --></p>\n<div id=\"disqus_thread\">&nbsp;</div>"
tags:
  - label: "Under the hood"
    value: "under-the-hood"
